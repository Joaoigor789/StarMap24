<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Rastreador de Satélites</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh;
        }

        .leaflet-control-coordinates {
            background: rgba(255, 255, 255, 0.7);
            padding: 3px 6px;
            font-size: 12px;
        }

        .sidebar {
            position: absolute;
            top: 50px;
            right: 10px;
            width: 140px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
        }

        .sidebar button {
            padding: 5px;
            font-size: 12px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div class="sidebar">
        <button onclick="centerMap()">Centralizar Mapa</button>
        <button onclick="toggleOrbit()">Mostrar/Ocultar Órbitas</button>
        <button onclick="pauseTracking()">Pausar/Retomar</button>
        <button onclick="showSatellites()">Lista Satélites</button>
    </div>



    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="dum.js"></script>
    <script src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>
    <script src="https://unpkg.com/satellite.js/dist/satellite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>



    <script>
        const sunIcon = L.icon({
            iconUrl: 'config/img/sun.png',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        const moonIcon = L.icon({
            iconUrl: 'config/img/moon.png',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        let sunMarker = null;
        let moonMarker = null;

        function updateSunMoon() {
            const now = new Date();


            
            
            const sunPos = SunCalc.getPosition(now, 0, 0);
            const sunLat = sunPos.altitude * 180 / Math.PI; 
            const sunLon = sunPos.azimuth * 180 / Math.PI;  

            
            const sunCoords = SunCalc.getPosition(now, 0, 0);
            const subSolarLat = sunCoords.altitude * 180 / Math.PI; 
            const subSolarLon = - (sunCoords.azimuth * 180 / Math.PI); 

            if (!sunMarker) {
                sunMarker = L.marker([subSolarLat, subSolarLon], { icon: sunIcon }).addTo(map).bindPopup("Sol");
            } else {
                sunMarker.setLatLng([subSolarLat, subSolarLon]);
            }

            
            const moonPos = SunCalc.getMoonPosition(now, 0, 0);
            const subMoonLat = moonPos.altitude * 180 / Math.PI;
            const subMoonLon = - (moonPos.azimuth * 180 / Math.PI);

            if (!moonMarker) {
                moonMarker = L.marker([subMoonLat, subMoonLon], { icon: moonIcon }).addTo(map).bindPopup("Lua");
            } else {
                moonMarker.setLatLng([subMoonLat, subMoonLon]);
            }
        }







        const map = L.map('map').setView([0, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        
        const coordsControl = L.control({ position: 'bottomleft' });
        coordsControl.onAdd = function () {
            const div = L.DomUtil.create('div', 'leaflet-control-coordinates');
            div.innerHTML = 'Lat: 0, Lon: 0';
            map.on('mousemove', e => div.innerHTML = `Lat: ${e.latlng.lat.toFixed(4)}, Lon: ${e.latlng.lng.toFixed(4)}`);
            return div;
        }
        coordsControl.addTo(map);

        const satelliteIcon = L.icon({
            iconUrl: 'config/img/sat.png', 
            iconSize: [32, 32],
            iconAnchor: [16, 16],
            popupAnchor: [0, -16]
        });

        const satellites = [];
        const MAX_SATELLITES = 100;
        let showOrbits = true;
        let trackingPaused = false;


        async function loadSatellites() {
            try {
                const res = await fetch('/tle/all');
                if (!res.ok) throw new Error('Erro ao buscar TLE');
                const txt = await res.text();
                const lines = txt.split('\n');

                for (let i = 0, count = 0; i < lines.length; i += 3) {
                    if (count >= MAX_SATELLITES) break;
                    if (!lines[i] || !lines[i + 1] || !lines[i + 2]) continue;

                    satellites.push({
                        name: lines[i].trim(),
                        tle1: lines[i + 1].trim(),
                        tle2: lines[i + 2].trim(),
                        marker: null,
                        orbit: null
                    });
                    count++;
                }

                setInterval(updatePositions, 1000);
            } catch (err) {
                console.error('Erro ao carregar satélites:', err);
            }
        }


        function updatePositions() {
    if (trackingPaused || !satellites.length) return;
    const now = new Date();

    satellites.forEach(sat => {
        const satrec = satellite.twoline2satrec(sat.tle1, sat.tle2);
        const pv = satellite.propagate(satrec, now);
        if (!pv.position) return;

        const gmst = satellite.gstime(now);
        const posGd = satellite.eciToGeodetic(pv.position, gmst);
        const lat = satellite.degreesLat(posGd.latitude);
        const lon = satellite.degreesLong(posGd.longitude);
        if (isNaN(lat) || isNaN(lon)) return;

        
        if (!sat.marker) {
            sat.marker = L.marker([lat, lon], { 
                icon: satelliteIcon, 
                rotationAngle: 0, 
                rotationOrigin: 'center center' 
            }).addTo(map).bindPopup(sat.name);
        } else {
            sat.marker.setLatLng([lat, lon]);
        }

        
        const nextTime = new Date(now.getTime() + 1000);
        const nextPv = satellite.propagate(satrec, nextTime);
        if (nextPv.position) {
            const nextGd = satellite.eciToGeodetic(nextPv.position, satellite.gstime(nextTime));
            const nextLat = satellite.degreesLat(nextGd.latitude);
            const nextLon = satellite.degreesLong(nextGd.longitude);
            const angle = Math.atan2(nextLat - lat, nextLon - lon) * (180 / Math.PI);
            sat.marker.setRotationAngle(angle);
        }

        
        sat.marker.getPopup().setContent(`<b>${sat.name}</b><br>Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`);

        
        if (showOrbits) {
            drawOrbit(sat, now);
        } else {
            if (sat.orbit) {
                sat.orbit.remove();
                sat.orbit = null;
            }
        }
    });

    updateSunMoon();
}


function drawOrbit(sat, now) {
    const satrec = satellite.twoline2satrec(sat.tle1, sat.tle2);
    const orbitLine = [];

    for (let i = 0; i <= 30; i++) {
        const future = new Date(now.getTime() + i * 2 * 60 * 1000);
        const futPv = satellite.propagate(satrec, future);
        if (!futPv.position) continue;
        const futGd = satellite.eciToGeodetic(futPv.position, satellite.gstime(future));
        orbitLine.push([satellite.degreesLat(futGd.latitude), satellite.degreesLong(futGd.longitude)]);
    }

    if (!sat.orbit) {
        sat.orbit = L.polyline(orbitLine, {
            color: 'rgba(255,0,0,0.2)',
            dashArray: '5,5',
            opacity: 0.3
        }).addTo(map);
    } else {
        sat.orbit.setLatLngs(orbitLine);
    }
}



        function centerMap() { map.setView([0, 0], 2); }
        function toggleOrbit() { showOrbits = !showOrbits; }
        function pauseTracking() { trackingPaused = !trackingPaused; }
        function showSatellites() {
            let list = "Satélites no mapa:\n";
            satellites.forEach(s => list += `${s.name}\n`);
            alert(list);
        }

        L.control.zoom({ position: 'topright' }).addTo(map);

        loadSatellites();
        setInterval(updateSunMoon, 1000);
    </script>
</body>

</html>